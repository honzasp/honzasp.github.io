// Generated by CoffeeScript 1.6.3
(function() {
  define(["exports", "jquery", "map", "render", "tank", "bullet", "particle", "collisions", "update"], function(exports, $, Map, Render, Tank, Bullet, Particle, Collisions, Update) {
    var Game;
    Game = exports;
    Game.MAX_GARBAGE_RATIO = 0.5;
    Game.init = function(settings, callback) {
      var game, info, map, playerInfos;
      map = Map.gen(settings);
      playerInfos = Game.init.createPlayers(settings, map);
      game = {
        dom: Game.init.prepareDom(game),
        map: map,
        tanks: (function() {
          var _i, _len, _results;
          _results = [];
          for (_i = 0, _len = playerInfos.length; _i < _len; _i++) {
            info = playerInfos[_i];
            _results.push(Game.createTank(game, info));
          }
          return _results;
        })(),
        bullets: [],
        particles: [],
        bonuses: [],
        size: {
          x: 800,
          y: 600
        },
        events: void 0,
        tickLen: 1.0 / settings["fps"],
        timer: void 0,
        playerInfos: playerInfos,
        callback: callback,
        mode: settings.mode,
        time: 0,
        useHud: settings.useHud,
        useNameTags: settings.useNameTags
      };
      Game.resizeCanvas(game);
      Game.rebindListeners(game);
      return game;
    };
    Game.init.prepareDom = function(game) {
      var $body, $canvas, $main, $oldBody, ctx;
      $oldBody = $("body").detach();
      $body = $("<body>").appendTo($("html"));
      $main = $("<div>").appendTo($body);
      $canvas = $("<canvas>").appendTo($main);
      $canvas.css({
        "display": "block",
        "position": "fixed",
        "top": "0px",
        "left": "0px",
        "margin": "0px",
        "padding": "0px"
      });
      ctx = $canvas[0].getContext("2d");
      return {
        $body: $body,
        $oldBody: $oldBody,
        $main: $main,
        $canvas: $canvas,
        ctx: ctx,
        $pauseBox: void 0
      };
    };
    Game.init.createPlayers = function(settings, map) {
      var def, idx, _i, _len, _ref, _results;
      _ref = settings.playerDefs;
      _results = [];
      for (idx = _i = 0, _len = _ref.length; _i < _len; idx = ++_i) {
        def = _ref[idx];
        _results.push({
          index: idx,
          base: map.bases[idx],
          destroyed: 0,
          hits: 0,
          keys: def.keys,
          color: def.color,
          name: def.name
        });
      }
      return _results;
    };
    Game.createTank = function(game, playerInfo) {
      var color, idx, x, y, _ref;
      idx = playerInfo.index, (_ref = playerInfo.base, x = _ref.x, y = _ref.y), color = playerInfo.color;
      return new Tank(idx, x + Map.BASE_SIZE / 2, y + Map.BASE_SIZE / 2, 0, color);
    };
    Game.deinit = function(game) {
      Game.stop(game);
      Game.unbindListeners(game);
      game.dom.$body.remove();
      game.dom.$oldBody.appendTo($("html"));
      return game.callback();
    };
    Game.tankDestroyed = function(game, index, guilty) {
      if (guilty == null) {
        guilty = void 0;
      }
      if (guilty != null) {
        game.playerInfos[guilty].hits += 1;
      }
      game.playerInfos[index].destroyed += 1;
      switch (game.mode.mode) {
        case "lives":
          if (game.playerInfos[index].destroyed >= game.mode.lives) {
            Game.finish(game);
          }
          break;
        case "hits":
          if ((guilty != null) && game.playerInfos[guilty].hits >= game.mode.hits) {
            Game.finish(game);
          }
      }
      if (game.playerInfos[index].lives <= 0) {
        return Game.finish(game);
      }
    };
    Game.boom = function(game, pos, spec) {
      return Update.boom(game, pos, spec);
    };
    Game.rebindListeners = function(game) {
      if (game.events != null) {
        Game.unbindListeners(game);
      }
      game.events = Game.events(game);
      return $(window).on(game.events);
    };
    Game.unbindListeners = function(game) {
      if (game.events == null) {
        return;
      }
      $(window).off(game.events);
      return game.events = void 0;
    };
    Game.events = function(game) {
      var backwardOff, backwardOn, changeOn, fireOff, fireOn, forwardOff, forwardOn, leftOff, leftOn, rightOff, rightOn;
      forwardOn = function(idx) {
        return game.tanks[idx].acc = 1;
      };
      backwardOn = function(idx) {
        return game.tanks[idx].acc = -1;
      };
      leftOn = function(idx) {
        return game.tanks[idx].rot = 1;
      };
      rightOn = function(idx) {
        return game.tanks[idx].rot = -1;
      };
      fireOn = function(idx) {
        return game.tanks[idx].firing = true;
      };
      changeOn = function(idx) {
        return game.tanks[idx].change();
      };
      forwardOff = function(idx) {
        if (game.tanks[idx].acc > 0) {
          return game.tanks[idx].acc = 0;
        }
      };
      backwardOff = function(idx) {
        if (game.tanks[idx].acc < 0) {
          return game.tanks[idx].acc = 0;
        }
      };
      leftOff = function(idx) {
        if (game.tanks[idx].rot > 0) {
          return game.tanks[idx].rot = 0;
        }
      };
      rightOff = function(idx) {
        if (game.tanks[idx].rot < 0) {
          return game.tanks[idx].rot = 0;
        }
      };
      fireOff = function(idx) {
        return game.tanks[idx].firing = false;
      };
      return {
        keydown: function(evt) {
          var idx, keys, _i, _len, _ref;
          if (evt.which === 27) {
            Game.pause(game);
          }
          _ref = game.playerInfos;
          for (idx = _i = 0, _len = _ref.length; _i < _len; idx = ++_i) {
            keys = _ref[idx].keys;
            if (evt.which === keys.forward) {
              forwardOn(idx);
            }
            if (evt.which === keys.backward) {
              backwardOn(idx);
            }
            if (evt.which === keys.left) {
              leftOn(idx);
            }
            if (evt.which === keys.right) {
              rightOn(idx);
            }
            if (evt.which === keys.fire) {
              fireOn(idx);
            }
            if (evt.which === keys.change) {
              changeOn(idx);
            }
          }
          return void 0;
        },
        keyup: function(evt) {
          var idx, keys, _i, _len, _ref;
          _ref = game.playerInfos;
          for (idx = _i = 0, _len = _ref.length; _i < _len; idx = ++_i) {
            keys = _ref[idx].keys;
            if (evt.which === keys.forward) {
              forwardOff(idx);
            }
            if (evt.which === keys.backward) {
              backwardOff(idx);
            }
            if (evt.which === keys.left) {
              leftOff(idx);
            }
            if (evt.which === keys.right) {
              rightOff(idx);
            }
            if (evt.which === keys.fire) {
              fireOff(idx);
            }
          }
          return void 0;
        },
        resize: function(evt) {
          return Game.resizeCanvas(game);
        }
      };
    };
    Game.resizeCanvas = function(game) {
      game.size.x = window.innerWidth;
      game.size.y = window.innerHeight;
      game.dom.$canvas.attr("width", game.size.x);
      game.dom.$canvas.attr("height", game.size.y);
      return Render.game(game);
    };
    Game.start = function(game) {
      if (game.timer != null) {
        Game.stop(game);
      }
      return game.timer = setInterval((function() {
        return Game.tick(game);
      }), game.tickLen * 1000);
    };
    Game.stop = function(game) {
      if (game.timer != null) {
        clearInterval(game.timer);
      }
      return game.timer = void 0;
    };
    Game.pause = function(game) {
      var _ref;
      Game.stop(game);
      Game.unbindListeners(game);
      if ((_ref = game.dom.$pauseBox) != null) {
        _ref.remove();
      }
      return game.dom.$pauseBox = Game.pause.createBox(game);
    };
    Game.pause.createBox = function(game) {
      var $box, $quitBtn, $resumeBtn;
      $box = $("<div class='pause-box' />").appendTo(game.dom.$main);
      $box.css({
        "position": "absolute",
        "top": "100px",
        "left": "100px",
        "background": "#fff"
      });
      $resumeBtn = $("<input type='button' name='resume' value='Resume'>").appendTo($box);
      $quitBtn = $("<input type='button' name='quit' value='Quit'>").appendTo($box);
      $quitBtn.attr("disabled", "disabled");
      setTimeout((function() {
        return $quitBtn.removeAttr("disabled");
      }), 1500);
      Game.createResults(game).appendTo($box);
      $resumeBtn.click(function() {
        return Game.resume(game);
      });
      $quitBtn.click(function() {
        return Game.deinit(game);
      });
      return $box;
    };
    Game.resume = function(game) {
      var _ref;
      if ((_ref = game.dom.$pauseBox) != null) {
        _ref.remove();
      }
      game.dom.$pauseBox = void 0;
      Game.rebindListeners(game);
      return Game.start(game);
    };
    Game.finish = function(game) {
      var $box, $okBtn;
      Game.stop(game);
      $box = $("<div class='finish-box' />").appendTo(game.dom.$main);
      $box.css({
        "position": "absolute",
        "top": "100px",
        "left": "100px",
        "background": "#fff"
      });
      Game.createResults(game).appendTo($box);
      $okBtn = $("<input type='button' name='ok' value='Ok'>").appendTo($box);
      return $okBtn.click(function() {
        return Game.deinit(game);
      });
    };
    Game.createResults = function(game) {
      var $list, info, _i, _len, _ref;
      $list = $("<ul />");
      _ref = game.playerInfos;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        info = _ref[_i];
        $("<li />").text("" + info.index + ": -" + info.destroyed + "/+" + info.hits).appendTo($list);
      }
      return $list;
    };
    Game.tick = function(game) {
      Update.game(game, game.tickLen);
      Render.game(game);
      if (game.mode.mode === "time" && game.time > game.mode.time) {
        return Game.finish(game);
      }
    };
    return Game;
  });

}).call(this);
